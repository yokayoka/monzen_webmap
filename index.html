<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>èƒ½ç™»åŠå³¶ãƒãƒƒãƒ—ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼å‚ç…§ï¼‹ç¾åœ¨åœ°è¡¨ç¤ºãƒ»ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100dvh; width: 100%; }
    /* ã‚¿ãƒƒãƒ—ã—ã‚„ã™ã„UI */
    .leaflet-touch .leaflet-bar a { width: 42px; height: 42px; line-height: 42px; font-size: 16px; }

    /* å³ä¸Šã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰ã‚’å‰é¢ã« */
    .leaflet-top.leaflet-right { z-index: 1100; }
    /* å³ä¸‹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆã‚ºãƒ¼ãƒ ï¼‹ç¾åœ¨åœ°ï¼‰ã‚’å‰é¢ã« */
    .leaflet-bottom.leaflet-right { z-index: 1100; }

    /* ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®ï¼ˆLeafletæ¨™æº–ãƒãƒ¼ã«åˆã‚ã›ã‚‹ï¼‰ */
    .leaflet-control-locate.leaflet-bar a {
      text-align: center;
      text-decoration: none;
      display: block;
      font-size: 20px;
      line-height: 42px;
    }
    .leaflet-control-locate.leaflet-bar a:focus {
      outline: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // --- åˆæœŸä¸­å¿ƒï¼ˆå¤‰æ›´å¾Œã®åº§æ¨™ã«åˆã‚ã›ã¦ãã ã•ã„ï¼‰ ---
    const ini = { lat: 37.29182, lng: 137.76769, zoom: 13 };

    // ã‚ºãƒ¼ãƒ ã¯å³ä¸‹ã«å‡ºã—ãŸã„ã®ã§ã€mapåˆæœŸåŒ–æ™‚ã¯ zoomControl: false ã«ã—ã¦å¾Œã‹ã‚‰è¿½åŠ 
    const map = L.map('map', {
      center: [ini.lat, ini.lng],
      zoom: ini.zoom,
      zoomControl: false,
      tap: true,
      tapTolerance: 15
    });

    // ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆï¼‹ï¼âˆ’ï¼‰ã‚’å³ä¸‹ã«
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // ---- Base layers ----
    const lyrbfCSMap = L.tileLayer('https://www2.ffpri.go.jp/soilmap/tile/cs_noto/{z}/{x}/{y}.png', {
      attribution: "CSMap by FFPRI", minZoom: 8, maxZoom: 17
    }).addTo(map); // æ—¢å®šãƒ¬ã‚¤ãƒ¤
    const lyrafCSMap = L.tileLayer('https://rinya.geospatial.jp/tile/csmaptile_noto/{z}/{x}/{y}.png', {
      attribution: "Forestry Agency", minZoom: 8, maxZoom: 17
    });

    const baseMaps = {
      "ç½å®³å‰CSç«‹ä½“å›³": lyrbfCSMap,
      "ç½å®³å¾ŒCSç«‹ä½“å›³": lyrafCSMap
    };

    // ---- Overlays ----
    const lyrGSI = L.tileLayer(
      "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
      { opacity: 0.3, attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>åœ°ç†é™¢ã‚¿ã‚¤ãƒ«</a>" }
    );
    const lyrGoogleHybrid = L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}");

    const overlays = {
      "åœ°ç†é™¢åœ°å›³": lyrGSI,
      "Googleé«˜è§£åƒåº¦": lyrGoogleHybrid
    };

    // ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¯å³ä¸Š
    L.control.layers(baseMaps, overlays, { collapsed: true, position: 'topright' }).addTo(map);

    // ======== ç¾åœ¨åœ°è¡¨ç¤ºï¼ˆGPSï¼‰æ©Ÿèƒ½ ========
    let locateMarker = null;
    let locateCircle = null;

    function showLocation(lat, lng, accuracy) {
      const latlng = [lat, lng];
      if (!locateMarker) {
        locateMarker = L.marker(latlng, { title: "ç¾åœ¨åœ°" }).addTo(map);
      } else {
        locateMarker.setLatLng(latlng);
      }

      if (!locateCircle) {
        locateCircle = L.circle(latlng, { radius: accuracy || 30, color: '#136aec', fillColor: '#136aec', fillOpacity: 0.15, weight: 2 }).addTo(map);
      } else {
        locateCircle.setLatLng(latlng);
        if (accuracy) locateCircle.setRadius(accuracy);
      }

      // ç¾åœ¨ã®ã‚ºãƒ¼ãƒ ãŒä½ã„å ´åˆã¯å°‘ã—å¯„ã›ã‚‹
      const targetZoom = Math.max(map.getZoom(), 15);
      map.setView(latlng, targetZoom, { animate: true });
    }

    function locateOnce() {
      if (!navigator.geolocation) {
        alert("ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          showLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy);
        },
        (err) => {
          // å…¸å‹çš„ãªã‚¨ãƒ©ãƒ¼ï¼šPERMISSION_DENIED, POSITION_UNAVAILABLE, TIMEOUT
          console.warn("Geolocation error:", err);
          switch (err.code) {
            case err.PERMISSION_DENIED:
              alert("ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
              break;
            case err.POSITION_UNAVAILABLE:
              alert("ç¾åœ¨åœ°ã‚’ç‰¹å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å±‹å¤–ã§å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
              break;
            case err.TIMEOUT:
              alert("ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å›ç·šçŠ¶æ³ã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
              break;
            default:
              alert("ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          }
        },
        {
          enableHighAccuracy: true, // ã§ãã‚‹ã ã‘ç²¾åº¦ã®é«˜ã„ä½ç½®
          timeout: 10000,           // 10ç§’ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
          maximumAge: 0             // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ä½¿ã‚ãªã„
        }
      );
    }

    // Leafletã®ãƒãƒ¼ã«ã€ŒğŸ“ï¼ˆç¾åœ¨åœ°ï¼‰ã€ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆå³ä¸‹ãƒ»ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³ã®ä¸Šå´ã«ä¸¦ã¶ï¼‰
    const LocateControl = L.Control.extend({
      options: { position: 'bottomright' },
      onAdd: function() {
        const container = L.DomUtil.create('div', 'leaflet-control-locate leaflet-bar');
        const link = L.DomUtil.create('a', '', container);
        link.href = '#';
        link.title = 'ç¾åœ¨åœ°ã¸ç§»å‹•';
        link.setAttribute('role', 'button');
        link.setAttribute('aria-label', 'ç¾åœ¨åœ°ã¸ç§»å‹•');
        link.innerHTML = 'ğŸ“';

        // ãƒãƒƒãƒ—ã®ãƒ‰ãƒ©ãƒƒã‚°ãƒ»ã‚ºãƒ¼ãƒ ã‚’æŠ‘æ­¢ã—ã¤ã¤ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.on(link, 'click', (e) => {
          L.DomEvent.preventDefault(e);
          locateOnce();
        });
        return container;
      }
    });
    map.addControl(new LocateControl());

    // ç”»é¢å›è»¢ã‚„é«˜ã•å¤‰åŒ–ã«è¿½å¾“
    addEventListener('orientationchange', () => setTimeout(() => map.invalidateSize(), 250));
    addEventListener('resize', () => setTimeout(() => map.invalidateSize(), 250));
  </script>
</body>
</html>
