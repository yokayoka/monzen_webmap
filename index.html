<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>能登半島マップ（レイヤー参照＋現在地表示・モバイル対応）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100dvh; width: 100%; }
    .leaflet-touch .leaflet-bar a { width: 42px; height: 42px; line-height: 42px; font-size: 16px; }
    .leaflet-top.leaflet-right { z-index: 1100; }
    .leaflet-bottom.leaflet-right { z-index: 1100; }
    .leaflet-control-locate.leaflet-bar a {
      text-align: center; text-decoration: none; display: block;
      font-size: 20px; line-height: 42px;
    }
    .leaflet-control-locate.leaflet-bar a:focus { outline: none; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // --- 既定値（パラメータが無いとき用） ---
    const ini = { lat: 37.2934, lng: 136.7883, zoom: 13 };

    // URLパラメータで上書き: ?y=<lat>&x=<lng>&z=<zoom>
    (function applyUrlCenter() {
      const p = new URLSearchParams(location.search);
      const y = parseFloat(p.get('y'));   // 緯度
      const x = parseFloat(p.get('x'));   // 経度
      const z = parseInt(p.get('z'), 10); // ズーム
      if (Number.isFinite(y) && y >= -90 && y <= 90 &&
          Number.isFinite(x) && x >= -180 && x <= 180) {
        ini.lat = y; ini.lng = x;
      }
      if (Number.isFinite(z)) ini.zoom = Math.min(19, Math.max(4, z));
    })();

    // ---- 地図本体（※初期化は1回だけ）----
    const map = L.map('map', {
      center: [ini.lat, ini.lng],
      zoom: ini.zoom,
      zoomControl: false,
      tap: true,
      tapTolerance: 15
    });

    // ズームコントロール（＋／−）を右下に
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // ---- Base layers ----
    const lyrbfCSMap = L.tileLayer('https://www2.ffpri.go.jp/soilmap/tile/cs_noto/{z}/{x}/{y}.png', {
      attribution: "CSMap by FFPRI", minZoom: 8, maxZoom: 17
    }).addTo(map); // 既定レイヤ
    const lyrafCSMap = L.tileLayer('https://rinya.geospatial.jp/tile/csmaptile_noto/{z}/{x}/{y}.png', {
      attribution: "Forestry Agency", minZoom: 8, maxZoom: 17
    });
    const lyrGSI = L.tileLayer(
      "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png", {
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" 
    });
    const lyrOrt60th = L.tileLayer(
      "https://cyberjapandata.gsi.go.jp/xyz/ort_old10/{z}/{x}/{y}.png", {
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" 
    });        
    const lyrOrt70th = L.tileLayer(
      "https://cyberjapandata.gsi.go.jp/xyz/gazo1/{z}/{x}/{y}.jpg", {
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>" 
    });    
    const lyrGoogleHybrid = L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}");
    const lyrOrt202404 = L.tileLayer(
      'https://cyberjapandata.gsi.go.jp/xyz/20240102noto_0405_0426do/{z}/{x}/{y}.png', {
      attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>", minZoom: 10, maxZoom: 18
    });
    const lyrOrt202409 = L.tileLayer(
      'https://cyberjapandata.gsi.go.jp/xyz/20240923rain_wajimaseibu_0924do_sokuho/{z}/{x}/{y}.png', {
      attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>", minZoom: 10, maxZoom: 18
    });

    const lyrOrt1991 = L.tileLayer(
      "tiles/ort1991/{z}/{x}/{y}.png", {
      attribution: "FFPRI", minZoom: 8, maxZoom: 17
    });

    const baseMaps = {
      "地震前CS立体図": lyrbfCSMap,
      "地震後CS立体図": lyrafCSMap,
      "地理院地図": lyrGSI,
      "1960年代オルソ": lyrOrt60th,
      "1970年代オルソ": lyrOrt70th,
      "1991年オルソ": lyrOrt1991,
      "Google高解像度（地震前）": lyrGoogleHybrid,
      "地震後オルソ": lyrOrt202404,
      "豪雨後オルソ": lyrOrt202409      
    };

    // ---- Overlays（空の GeoJSON レイヤを用意）----
    const jsonArtif = L.geoJSON(null, {
      pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
        radius: 5, weight: 1, color: '#b22222', fillColor: '#ff6666', fillOpacity: 0.7
      }),
      style: () => ({ color: '#b22222', weight: 2, fillOpacity: 0.3 }),
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        const html = [
          p.name ? `<div><strong>${p.name}</strong></div>` : '',
          p.type ? `<div>種別: ${p.type}</div>` : '',
          p.date ? `<div>日付: ${p.date}</div>` : ''
        ].join('');
        if (html) layer.bindPopup(html);
      }
    });

    const jsonNatural = L.geoJSON(null, {
      pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
        radius: 5, weight: 1, color: '#0b5', fillColor: '#6fdc6f', fillOpacity: 0.7
      }),
      style: () => ({ color: '#0b5', weight: 2, fillOpacity: 0.3 }),
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        const html = [
          p.name ? `<div><strong>${p.name}</strong></div>` : '',
          p.type ? `<div>種別: ${p.type}</div>` : '',
          p.date ? `<div>日付: ${p.date}</div>` : ''
        ].join('');
        if (html) layer.bindPopup(html);
      }
    });

     const jsonHz_afst = L.geoJSON(null, {
      pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
        radius: 5, weight: 1, color: '#000070', fillColor: '#4169e1', fillOpacity: 0.7
      }),
      style: () => ({ color: '#000070', weight: 2, fillOpacity: 0.3 }),
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        const html = [
          p.name ? `<div><strong>${p.name}</strong></div>` : '',
          p.type ? `<div>種別: ${p.type}</div>` : '',
          p.date ? `<div>日付: ${p.date}</div>` : ''
        ].join('');
        if (html) layer.bindPopup(html);
      }
    });   

     const jsonFill = L.geoJSON(null, {
      pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
        radius: 5, weight: 1, color: '#ffd700', fillColor: '#ffff00', fillOpacity: 0.7
      }),
      style: () => ({ color: '#ffd700', weight: 2, fillOpacity: 0.3 }),
      onEachFeature: (feature, layer) => {
        const p = feature.properties || {};
        const html = [
          p.name ? `<div><strong>${p.name}</strong></div>` : '',
          p.type ? `<div>種別: ${p.type}</div>` : '',
          p.date ? `<div>日付: ${p.date}</div>` : ''
        ].join('');
        if (html) layer.bindPopup(html);
      }
    });   


    // レイヤーコントロール（右上）
    const overlays = {
      "崩壊（人為）": jsonArtif,
      "崩壊（自然）": jsonNatural,
      "豪雨後災害（地理院）": jsonHz_afst,
      "盛土": jsonFill
    };
    L.control.layers(baseMaps, overlays, { collapsed: true, position: 'topright' }).addTo(map);

    // ---- GeoJSON の読み込み ----
    // ※ 初期表示からONにしたい場合は、読み込み後に addTo(map) する
    //    さらに全体へ寄せたい場合は fitBounds する
    Promise.all([
      fetch('src/json/artif.json').then(r => r.json()).then(g => { jsonArtif.addData(g); }),
      fetch('src/json/natural.json').then(r => r.json()).then(g => { jsonNatural.addData(g); }).catch(()=>{}),
      fetch('src/json/afst_gsi.geojson').then(r => r.json()).then(g => { jsonHz_afst.addData(g); }).catch(()=>{}),
      fetch('src/json/fill.geojson').then(r => r.json()).then(g => { jsonFill.addData(g); }).catch(()=>{})
    ]).then(() => {
      // 初期表示でONにしたいならコメント解除
      // if (jsonArtif.getLayers().length) jsonArtif.addTo(map);
      // if (jsonNatural.getLayers().length) jsonNatural.addTo(map);

      // 両方の範囲に自動で寄せたい場合（任意）
      // const group = L.featureGroup([jsonArtif, jsonNatural].filter(l => l.getLayers().length));
      // if (group.getLayers().length) map.fitBounds(group.getBounds().pad(0.1));
    }).catch(err => {
      console.error('GeoJSON 読み込みエラー:', err);
    });

    // ======== 現在地表示（GPS）機能 ========
    let locateMarker = null, locateCircle = null;
    function showLocation(lat, lng, accuracy) {
      const latlng = [lat, lng];
      if (!locateMarker) locateMarker = L.marker(latlng, { title: "現在地" }).addTo(map);
      else locateMarker.setLatLng(latlng);

      if (!locateCircle) locateCircle = L.circle(latlng, { radius: accuracy || 30, color: '#136aec', fillColor: '#136aec', fillOpacity: 0.15, weight: 2 }).addTo(map);
      else { locateCircle.setLatLng(latlng); if (accuracy) locateCircle.setRadius(accuracy); }

      map.setView(latlng, Math.max(map.getZoom(), 15), { animate: true });
    }
    function locateOnce() {
      if (!navigator.geolocation) { alert("この端末/ブラウザは位置情報に対応していません。"); return; }
      navigator.geolocation.getCurrentPosition(
        pos => showLocation(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy),
        err => {
          console.warn("Geolocation error:", err);
          alert("位置情報の取得に失敗しました（権限/環境をご確認ください）。");
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }
    const LocateControl = L.Control.extend({
      options: { position: 'bottomright' },
      onAdd: function() {
        const container = L.DomUtil.create('div', 'leaflet-control-locate leaflet-bar');
        const link = L.DomUtil.create('a', '', container);
        link.href = '#'; link.title = '現在地へ移動'; link.setAttribute('role', 'button'); link.setAttribute('aria-label', '現在地へ移動'); link.innerHTML = '📍';
        L.DomEvent.disableClickPropagation(container);
        L.DomEvent.on(link, 'click', (e) => { L.DomEvent.preventDefault(e); locateOnce(); });
        return container;
      }
    });
    map.addControl(new LocateControl());

    addEventListener('orientationchange', () => setTimeout(() => map.invalidateSize(), 250));
    addEventListener('resize', () => setTimeout(() => map.invalidateSize(), 250));
  </script>
</body>
</html>
